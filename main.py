from model import Model
from fetch_images import fetch_all_images_for
from data_processing import DataProcessing
from plotting import plot_category_clusters, proj_2d_single_diff, proj_2d
import torch
import matplotlib.pyplot as plt

# Initialize model
MODEL_NAME = "google/paligemma2-3b-pt-224"
device = torch.device("cuda:0")
model = Model(MODEL_NAME, device)

# Prepare dataset
overall_category = "animals"
data: dict[str, list[str]] = {
    "mammal": [
        "beaver",
        "panther",
        "lion",
        "llama",
        "colobus",
        "marmoset",
        "rabbit",
        "dingo",
        "pika",
        "okapi",
        "gazelle",
        "margay",
        "echidna",
        "vicuna",
        "grizzly",
        "aardvark",
        "anteater",
        "orangutan",
        "wallaby",
        "meerkat",
        "mongoose",
        "bongo",
        "hamster",
        "caracal",
        "whale",
        "addax",
        "boar",
        "puma",
        "peccary",
        "bonobo",
        "dolphin",
        "proboscis",
        "otter",
        "sheep",
        "capuchin",
        "howler",
        "guinea",
        "horse",
        "chinchilla",
        "donkey",
        "mandrill",
        "warthog",
        "galago",
        "takin",
        "impala",
        "eland",
        "springbok",
        "chimpanzee",
        "waterbuck",
        "moose",
        "nutria",
        "mink",
        "platypus",
        "mole",
        "ibex",
        "dormouse",
        "wolverine",
        "buffalo",
        "gorilla",
        "spermwhale",
        "fennec",
        "gerbil",
        "goat",
        "pangolin",
        "vole",
        "panda",
        "pronghorn",
        "polarbear",
        "gibbon",
        "jaguar",
        "fox",
        "agouti",
        "kudu",
        "snow-leopard",
        "finwhale",
        "gnu",
        "ape",
        "wombat",
        "tiger",
        "uakari",
        "dog",
        "saki",
        "hartebeest",
        "gemsbok",
        "pony",
        "redpanda",
        "jackal",
        "sloth",
        "alpaca",
        "muskox",
        "pig",
        "hedgehog",
        "coyote",
        "giraffe",
        "koala",
        "porpoise",
        "gelada",
        "chipmunk",
        "lynx",
        "lemur",
        "squirrel",
        "skunk",
        "topi",
        "hyena",
        "siamang",
        "walrus",
        "narwhal",
        "rodent",
        "cougar",
        "serow",
        "cat",
        "yak",
        "kangaroo",
        "tarsier",
        "elk",
        "chimp",
        "bison",
        "capybara",
        "papio",
        "armadillo",
        "tamarin",
        "black-bear",
        "loris",
        "ermine",
        "weasel",
        "hare",
        "monkey",
        "oryx",
        "camel",
        "ocelot",
        "marten",
        "beluga",
        "antelope",
        "caribou",
        "macaque",
        "rhinoceros",
        "ferret",
        "muskrat",
        "cheetah",
        "raccoon",
        "opossum",
        "deer",
        "langur",
        "sable",
        "gaur",
        "dugong",
        "zebu",
        "mule",
        "hippopotamus",
        "badger",
        "wolf",
        "manatee",
        "wildebeest",
        "shrew",
        "elephant",
        "rat",
        "tapir",
        "stoat",
        "baboon",
        "reindeer",
        "sea-lion",
        "polar-bear",
        "guanaco",
        "orca",
        "zebra",
        "cow",
        "porcupine",
        "leopard",
        "mouse",
    ],
    "bird": [
        "pigeon",
        "parrot",
        "albatross",
        "cockatoo",
        "magpie",
        "cardinal",
        "honeyeater",
        "hummingbird",
        "sedge",
        "kinglet",
        "kingfisher",
        "rhea",
        "plover",
        "thrush",
        "raven",
        "pelican",
        "ibis",
        "redshank",
        "mockingbird",
        "goldfinch",
        "tinamou",
        "cassowary",
        "chaffinch",
        "woodpecker",
        "peafowl",
        "cuckoo",
        "loon",
        "sunbird",
        "emu",
        "roadrunner",
        "waxwing",
        "harrier",
        "curlew",
        "godwit",
        "goose",
        "vulture",
        "avocet",
        "wagtail",
        "manakin",
        "snipe",
        "vireo",
        "partridge",
        "jay",
        "sandpiper",
        "dipper",
        "gadwall",
        "woodcock",
        "cotinga",
        "antpitta",
        "lovebird",
        "ptarmigan",
        "grebe",
        "hawk",
        "teal",
        "gnateater",
        "budgerigar",
        "oystercatcher",
        "osprey",
        "owl",
        "finch",
        "kite",
        "lorikeet",
        "wren",
        "hornbill",
        "turkey",
        "buzzard",
        "nightingale",
        "treecreeper",
        "tanager",
        "shoveler",
        "greenfinch",
        "puffin",
        "tern",
        "jacamar",
        "egret",
        "antbird",
        "tapaculo",
        "thrasher",
        "eagle",
        "brambling",
        "smew",
        "moorhen",
        "blackbird",
        "phalarope",
        "oriole",
        "toucan",
        "junco",
        "goldeneye",
        "turaco",
        "bunting",
        "flamingo",
        "keel",
        "redpoll",
        "macaw",
        "parakeet",
        "heron",
        "hoopoe",
        "duck",
        "sparrow",
        "catbird",
        "mallard",
        "coot",
        "flycatcher",
        "quail",
        "nuthatch",
        "bee-eater",
        "lapwing",
        "chicken",
        "guineafowl",
        "grosbeak",
        "swallow",
        "phoebe",
        "linnet",
        "kakapo",
        "cisticola",
        "kestrel",
        "ostrich",
        "dunlin",
        "reedbunting",
        "lark",
        "dove",
        "pintail",
        "falcon",
        "bullfinch",
        "pipit",
        "swan",
        "starling",
        "pheasant",
        "kiwi",
        "eider",
        "grouse",
        "pigeon",
        "shrike",
        "stork",
        "warbler",
        "cormorant",
        "merganser",
        "crossbill",
        "seagull",
        "canary",
        "scoter",
        "siskin",
    ],
    "reptile": [
        "viper",
        "lizard",
        "terrapin",
        "cobra",
        "anaconda",
        "gila",
        "skink",
        "crocodile",
        "anole",
        "iguana",
        "chameleon",
        "mamba",
        "gecko",
        "komodo",
        "snake",
        "tortoise",
        "alligator",
        "turtle",
        "tuatara",
    ],
    "fish": [
        "snapper",
        "anchovy",
        "moonfish",
        "herring",
        "dolphinfish",
        "pomfret",
        "crab",
        "barracuda",
        "arowana",
        "ladyfish",
        "salmon",
        "dace",
        "scallop",
        "carp",
        "eel",
        "flounder",
        "spadefish",
        "tilapia",
        "boxfish",
        "croaker",
        "goosefish",
        "pollock",
        "trout",
        "seahorse",
        "shark",
        "jewfish",
        "grayling",
        "tench",
        "mahi-mahi",
        "halibut",
        "bonefish",
        "ide",
        "urchin",
        "piranha",
        "rockfish",
        "swordtail",
        "tuna",
        "surgeonfish",
        "smelt",
        "mackerel",
        "sockeye",
        "fluke",
        "chub",
        "starfish",
        "tarpon",
        "pompano",
        "monkfish",
        "moray",
        "cod",
        "catfish",
        "clam",
        "ribbonfish",
        "rudd",
        "sturgeon",
        "coho",
        "jellyfish",
        "bitterling",
        "grunt",
        "roach",
        "pipefish",
        "weakfish",
        "grouper",
        "snook",
        "swordfish",
        "lingcod",
        "clownfish",
        "oyster",
        "haddock",
        "angelfish",
        "mussel",
        "sardine",
        "platy",
        "scorpionfish",
        "chinook",
        "triggerfish",
        "amberjack",
        "sablefish",
        "guppy",
        "mahi",
        "discus",
        "puffer",
        "mullet",
        "lobster",
        "kingfish",
        "pleco",
        "whitefish",
        "perch",
        "gar",
        "barbel",
        "shrimp",
        "bream",
        "wrass",
        "pike",
        "damselfish",
        "lionfish",
        "goldfish",
        "cichlid",
        "bleak",
        "scup",
        "bluefish",
    ],
    "amphibian": [
        "bullfrog",
        "siren",
        "toad",
        "treefrog",
        "frog",
        "olm",
        "axolotl",
        "surinam",
        "natterjack",
        "hellbender",
        "salamander",
        "tadpole",
        "glassfrog",
        "mudpuppy",
        "newt",
        "caecilian",
    ],
    "insect": [
        "mayfly",
        "grasshopper",
        "bedbug",
        "silverfish",
        "cicada",
        "dragonfly",
        "lacewing",
        "leech",
        "butterfly",
        "damselfly",
        "housefly",
        "termite",
        "earwig",
        "slug",
        "moth",
        "flea",
        "earthworm",
        "mosquito",
        "hornet",
        "snail",
        "ladybug",
        "cockroach",
        "gnat",
        "scarab",
        "scorpion",
        "caterpillar",
        "aphid",
        "thrips",
        "weevil",
        "beetle",
        "tarantula",
        "firefly",
        "millipede",
        "spider",
        "cricket",
        "wasp",
        "ant",
        "centipede",
        "mite",
        "bee",
    ],
}
categories = list(data.keys())
image_paths: dict[str, list[str]] = fetch_all_images_for(data, "data/animal_images")

# Calculate embeddings
data_processing = DataProcessing(model, device)
embeddings = data_processing.get_image_tokens(data, image_paths)

# Find nearest tokens
nearest_tokens = model.find_nearest_tokens(
    torch.cat([t.squeeze() for t in embeddings.values()], dim=0).mean(dim=0),
    top_k=10,
)

# Print results for first few image patches
for i, tokens in enumerate(nearest_tokens[:5]):
    print(f"Image patch {i}: {tokens}")

# tokens, embeddings = data_processing.get_text_embeddings(categories, data)
dirs = data_processing.estimate_dirs_from_embeddings(embeddings, overall_category)

# Visualize using a plot
print("Plotting category clusters...")
# # If Image
# --- Plot 1: Overall Category vs Sub-Category ---
plot_category_clusters(overall_category, categories[0], dirs, embeddings, model.g)

# # --- Plot 2: Sub-Category vs Sub-Category (1) ---
# plot_category_clusters(categories[0], categories[1], dirs, tokens)

# # --- Plot 3: Sub-Category vs Sub-Category (2) ---
# plot_category_clusters(categories[1], categories[2], dirs, tokens)

proj_2d(overall_category, categories[0], dirs, model.g)

plt.tight_layout()
plt.show()
